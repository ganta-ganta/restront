<!DOCTYPE html>
<html>
<head>
    <title>View Your Bill</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .bill-container { max-width: 800px; margin: 2rem auto; padding: 2rem; border: 1px solid #ddd; }
        .loading { display: flex; justify-content: center; padding: 5rem; }
        .error { color: #dc3545; text-align: center; padding: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <div class="spinner-border text-primary"></div>
        </div>
        
        <div id="bill-display" class="bill-container" style="display:none;">
            <!-- Bill content loads here -->
        </div>
        
        <div id="error-display" class="error" style="display:none;"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Initialize Firebase
         const firebaseConfig = {
    apiKey: "AIzaSyAhpW9iqp4O18sIysTyYE1Qk90pCizIysU",
    authDomain: "estront-d6831.firebaseapp.com",
    projectId: "estront-d6831",
    storageBucket: "estront-d6831.firebasestorage.app",
    messagingSenderId: "678690095471",
    appId: "1:678690095471:web:c62279b2c62a6f68ade89a",
    measurementId: "G-1SFVMT2W2E"
  };
        
        const db = firebase.firestore();
        
        async function loadBill() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order');
            
            if (!orderId) {
                showError("No order ID provided in URL");
                return;
            }
            
            try {
                // Search all restaurants for the order
                const restaurants = await db.collection('restaurants').get();
                let orderData = null;
                let restaurantData = null;
                
                for (const restaurant of restaurants.docs) {
                    const orderDoc = await restaurant.ref.collection('orders').doc(orderId).get();
                    if (orderDoc.exists) {
                        orderData = orderDoc.data();
                        restaurantData = restaurant.data();
                        break;
                    }
                }
                
                if (!orderData) {
                    showError("Bill not found. Please check the order number.");
                    return;
                }
                
                renderBill(orderData, restaurantData.settings);
                
            } catch (error) {
                console.error("Error loading bill:", error);
                showError("Error loading bill. Please try again later.");
            }
        }
        
        function renderBill(order, settings) {
            const billDisplay = document.getElementById('bill-display');
            
            // Format date
            const orderDate = order.date.toDate ? order.date.toDate() : new Date(order.date);
            
            // Calculate totals
            const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * (settings.taxRate / 100 || 0);
            const total = subtotal + tax;
            
            // Generate HTML
            billDisplay.innerHTML = `
                <h2 class="text-center">${settings.restaurantName || 'Restaurant'}</h2>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Order #:</strong> ${order.id}</p>
                        <p><strong>Date:</strong> ${orderDate.toLocaleString()}</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <p><strong>Table #:</strong> ${order.tableNumber || 'N/A'}</p>
                        <p><strong>Customer:</strong> ${order.customerName || 'Walk-in'}</p>
                    </div>
                </div>
                
                <table class="table mt-4">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th class="text-end">Price</th>
                            <th class="text-end">Qty</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${order.items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td class="text-end">₹${item.price.toFixed(2)}</td>
                                <td class="text-end">${item.quantity}</td>
                                <td class="text-end">₹${(item.price * item.quantity).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="text-end mt-4">
                    <p><strong>Subtotal:</strong> ₹${subtotal.toFixed(2)}</p>
                    <p><strong>Tax (${settings.taxRate || 0}%):</strong> ₹${tax.toFixed(2)}</p>
                    <hr>
                    <h4><strong>Total:</strong> ₹${total.toFixed(2)}</h4>
                </div>
                
                <div class="text-center mt-4">
                    <p>Thank you for dining with us!</p>
                </div>
            `;
            
            document.getElementById('loading').style.display = 'none';
            billDisplay.style.display = 'block';
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error-display');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Start loading when page loads
        window.addEventListener('DOMContentLoaded', loadBill);
    </script>
</body>
</html>
