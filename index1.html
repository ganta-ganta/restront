<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Billing System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            transition: all 0.3s;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.75);
            border-radius: 5px;
            margin-bottom: 5px;
        }
        .sidebar .nav-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link.active {
            color: white;
            background-color: #007bff;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .category-btn {
            margin: 5px;
            white-space: nowrap;
        }
        .menu-item-card {
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 15px;
        }
        .menu-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .order-item {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
        }
        .bill-print {
            background-color: white;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #ddd;
            max-width: 800px;
            margin: 0 auto;
        }
        .table-status {
            width: 100%;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 5px;
        }
        .table-status.available {
            background-color: #d4edda;
            color: #155724;
        }
        .table-status.occupied {
            background-color: #f8d7da;
            color: #721c24;
        }
        .table-status.reserved {
            background-color: #fff3cd;
            color: #856404;
        }
        .table-status:hover {
            transform: scale(1.03);
        }
        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        .kitchen-order-card {
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .kitchen-order-card.pending {
            border-left: 5px solid #ffc107;
        }
        .kitchen-order-card.preparing {
            border-left: 5px solid #fd7e14;
        }
        .kitchen-order-card.ready {
            border-left: 5px solid #28a745;
        }
        .kitchen-order-card.completed {
            border-left: 5px solid #6c757d;
        }
        .order-status-badge {
            cursor: pointer;
        }
        .qr-code-container {
            text-align: center;
            margin: 20px 0;
        }
        .qr-code {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            background-color: white;
            padding: 10px;
            border: 1px solid #ddd;
        }
        .invoice-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .bill-print, .bill-print * {
                visibility: visible;
            }
            .bill-print {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none;
            }
            .no-print {
                display: none !important;
            }
            .invoice-actions {
                display: none !important;
            }
        }
        .login-container {
            max-width: 400px;
            margin: 0 auto;
            padding-top: 100px;
        }
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <!-- Login Section (Initially shown) -->
    <div id="login-section" class="container">
        <div class="login-container">
            <div class="login-logo">
                <h2>Restaurant POS</h2>
                <p class="text-muted">Please sign in to continue</p>
            </div>
            <div class="card">
                <div class="card-body">
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="login-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="login-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="login-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="login-password" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Sign In</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (Initially hidden) -->
    <div id="app-container" class="container-fluid" style="display: none;">
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-md-2 sidebar p-3">
                <h4 class="text-center mb-4 text-white">Restaurant POS</h4>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="dashboard">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="tables">
                            <i class="fas fa-table me-2"></i>Table Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="orders">
                            <i class="fas fa-utensils me-2"></i>New Order
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="kitchen">
                            <i class="fas fa-utensils me-2"></i>Kitchen View
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="menu">
                            <i class="fas fa-list me-2"></i>Menu Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="reports">
                            <i class="fas fa-chart-bar me-2"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="settings">
                            <i class="fas fa-cog me-2"></i>Settings
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <a class="nav-link text-danger" href="#" id="logout-btn">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-10 p-4">
                <!-- Dashboard Section -->
                <div id="dashboard" class="content-section active">
                    <h3><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h3>
                    <hr>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Today's Orders</h5>
                                    <h2 class="card-text" id="today-orders">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Today's Revenue</h5>
                                    <h2 class="card-text" id="today-revenue">₹0.00</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Active Tables</h5>
                                    <h2 class="card-text" id="active-tables">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white mb-4">
                                <div class="card-body">
                                    <h5 class="card-title">Kitchen Pending</h5>
                                    <h2 class="card-text" id="kitchen-pending">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Recent Orders</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Order #</th>
                                                <th>Table</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-orders">
                                            <!-- Filled by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Popular Items</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Item</th>
                                                <th>Qty Sold</th>
                                                <th>Revenue</th>
                                            </tr>
                                        </thead>
                                        <tbody id="popular-items">
                                            <!-- Filled by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Management Section -->
                <div id="tables" class="content-section">
                    <h3><i class="fas fa-table me-2"></i>Table Management</h3>
                    <hr>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Table Status</h5>
                                    <button class="btn btn-sm btn-primary" id="refresh-tables">Refresh</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-grid" id="table-status-grid">
                                        <!-- Tables will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Active Orders</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Table</th>
                                                <th>Order ID</th>
                                                <th>Items</th>
                                                <th>Amount</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="active-orders-table">
                                            <!-- Filled by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h5>Table Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <form id="add-table-form">
                                        <div class="mb-3">
                                            <label for="new-table-number" class="form-label">Add New Table</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="new-table-number" min="1" required>
                                                <button class="btn btn-primary" type="submit">Add</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <form id="remove-table-form">
                                        <div class="mb-3">
                                            <label for="remove-table-number" class="form-label">Remove Table</label>
                                            <div class="input-group">
                                                <select class="form-select" id="remove-table-number" required>
                                                    <!-- Tables will be loaded here -->
                                                </select>
                                                <button class="btn btn-danger" type="submit">Remove</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Order Section -->
                <div id="orders" class="content-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="fas fa-utensils me-2"></i>New Order</h3>
                        <div>
                            <button class="btn btn-primary me-2" id="print-kitchen-order">Print Kitchen Order</button>
                            <button class="btn btn-success" id="complete-order">Complete Order</button>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Menu Categories</h5>
                                </div>
                                <div class="card-body">
                                    <div id="categories" class="d-flex flex-wrap">
                                        <!-- Categories will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h5>Menu Items</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="menu-items">
                                        <!-- Menu items will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Current Order</h5>
                                    <span class="badge bg-primary">Table: <span id="current-table-number">1</span></span>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="table-number" class="form-label">Table Number</label>
                                        <select class="form-select" id="table-number">
                                            <!-- Tables will be loaded here -->
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="customer-name" class="form-label">Customer Name</label>
                                        <input type="text" class="form-control" id="customer-name" placeholder="Optional">
                                    </div>
                                    <div class="mb-3">
                                        <label for="customer-phone" class="form-label">Customer Phone</label>
                                        <input type="tel" class="form-control" id="customer-phone" placeholder="Optional">
                                    </div>
                                    <hr>
                                    <div id="order-items">
                                        <!-- Order items will be displayed here -->
                                        <p class="text-muted text-center">No items added yet</p>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <h5>Total:</h5>
                                        <h5 id="order-total">₹0.00</h5>
                                    </div>
                                    <div class="d-grid gap-2 mt-3">
                                        <button class="btn btn-danger" id="clear-order">Clear Order</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kitchen View Section -->
                <div id="kitchen" class="content-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="fas fa-utensils me-2"></i>Kitchen Orders</h3>
                        <button class="btn btn-primary" id="refresh-kitchen">
                            <i class="fas fa-sync-alt me-1"></i> Refresh
                        </button>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <ul class="nav nav-tabs card-header-tabs" id="kitchen-tabs">
                                        <li class="nav-item">
                                            <a class="nav-link active" data-bs-toggle="tab" href="#pending-orders">Pending</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="tab" href="#preparing-orders">Preparing</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="tab" href="#ready-orders">Ready</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="tab" href="#completed-orders">Completed</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="kitchen-tab-content">
                                        <div class="tab-pane fade show active" id="pending-orders">
                                            <div class="row" id="pending-orders-container">
                                                <!-- Pending orders will be loaded here -->
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="preparing-orders">
                                            <div class="row" id="preparing-orders-container">
                                                <!-- Preparing orders will be loaded here -->
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="ready-orders">
                                            <div class="row" id="ready-orders-container">
                                                <!-- Ready orders will be loaded here -->
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="completed-orders">
                                            <div class="row" id="completed-orders-container">
                                                <!-- Completed orders will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu Management Section -->
                <div id="menu" class="content-section">
                    <h3><i class="fas fa-list me-2"></i>Menu Management</h3>
                    <hr>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Add New Category</h5>
                                </div>
                                <div class="card-body">
                                    <form id="add-category-form">
                                        <div class="mb-3">
                                            <label for="category-name" class="form-label">Category Name</label>
                                            <input type="text" class="form-control" id="category-name" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Add Category</button>
                                    </form>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h5>Add New Item</h5>
                                </div>
                                <div class="card-body">
                                    <form id="add-item-form">
                                        <div class="mb-3">
                                            <label for="item-category" class="form-label">Category</label>
                                            <select class="form-select" id="item-category" required>
                                                <!-- Categories will be loaded here -->
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="item-name" class="form-label">Item Name</label>
                                            <input type="text" class="form-control" id="item-name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="item-price" class="form-label">Price</label>
                                            <input type="number" step="0.01" class="form-control" id="item-price" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="item-description" class="form-label">Description (Optional)</label>
                                            <textarea class="form-control" id="item-description" rows="2"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Add Item</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Current Menu</h5>
                                </div>
                                <div class="card-body">
                                    <div id="menu-categories-accordion" class="accordion">
                                        <!-- Menu items by category will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports" class="content-section">
                    <h3><i class="fas fa-chart-bar me-2"></i>Reports</h3>
                    <hr>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Sales Report</h5>
                                </div>
                                <div class="card-body">
                                    <form id="sales-report-form">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="report-start-date" class="form-label">Start Date</label>
                                                <input type="date" class="form-control" id="report-start-date" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="report-end-date" class="form-label">End Date</label>
                                                <input type="date" class="form-control" id="report-end-date" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="report-type" class="form-label">Report Type</label>
                                            <select class="form-select" id="report-type">
                                                <option value="summary">Summary Report</option>
                                                <option value="detailed">Detailed Report</option>
                                                <option value="tax">Tax Report</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Generate Report</button>
                                        <button type="button" class="btn btn-secondary" id="export-report">Export to Excel</button>
                                    </form>
                                    <div id="sales-report-results" class="mt-3">
                                        <!-- Report results will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Bill Management</h5>
                                </div>
                                <div class="card-body">
                                    <form id="print-bill-form">
                                        <div class="mb-3">
                                            <label for="bill-order-id" class="form-label">Order ID</label>
                                            <input type="text" class="form-control" id="bill-order-id" required>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-primary" id="print-kitchen-bill">Kitchen Bill</button>
                                            <button type="button" class="btn btn-secondary" id="print-customer-bill">Customer Bill</button>
                                            <button type="button" class="btn btn-info" id="print-admin-bill">Admin Bill</button>
                                            <button type="button" class="btn btn-success" id="send-e-bill">Send E-Bill</button>
                                        </div>
                                    </form>
                                    <div class="mt-3" id="e-bill-status"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h5>Recent Orders</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Date</th>
                                        <th>Table</th>
                                        <th>Customer</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-orders-table">
                                    <!-- All orders will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings" class="content-section">
                    <h3><i class="fas fa-cog me-2"></i>Settings</h3>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Restaurant Information</h5>
                                </div>
                                <div class="card-body">
                                    <form id="restaurant-info-form">
                                        <div class="mb-3">
                                            <label for="restaurant-name" class="form-label">Restaurant Name</label>
                                            <input type="text" class="form-control" id="restaurant-name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="restaurant-address" class="form-label">Address</label>
                                            <textarea class="form-control" id="restaurant-address" rows="3" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="restaurant-phone" class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="restaurant-phone" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="restaurant-email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="restaurant-email">
                                        </div>
                                        <div class="mb-3">
                                            <label for="restaurant-gst" class="form-label">GST Number</label>
                                            <input type="text" class="form-control" id="restaurant-gst">
                                        </div>
                                        <div class="mb-3">
                                            <label for="restaurant-logo" class="form-label">Logo URL</label>
                                            <input type="url" class="form-control" id="restaurant-logo">
                                        </div>
                                        <button type="submit" class="btn btn-primary">Save Information</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>System Settings</h5>
                                </div>
                                <div class="card-body">
                                    <form id="system-settings-form">
                                        <div class="mb-3">
                                            <label for="tax-rate" class="form-label">Tax Rate (%)</label>
                                            <input type="number" step="0.01" class="form-control" id="tax-rate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="cgst-rate" class="form-label">CGST Rate (%)</label>
                                            <input type="number" step="0.01" class="form-control" id="cgst-rate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="sgst-rate" class="form-label">SGST Rate (%)</label>
                                            <input type="number" step="0.01" class="form-control" id="sgst-rate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="service-charge" class="form-label">Service Charge (%)</label>
                                            <input type="number" step="0.01" class="form-control" id="service-charge" required>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="enable-discount">
                                            <label class="form-check-label" for="enable-discount">Enable Discount Option</label>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="auto-print-kitchen">
                                            <label class="form-check-label" for="auto-print-kitchen">Auto-print Kitchen Orders</label>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="enable-e-bill">
                                            <label class="form-check-label" for="enable-e-bill">Enable E-Bill Option</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Save Settings</button>
                                    </form>
                                    <hr>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-danger" id="reset-data">Reset All Data</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Print Section (hidden) -->
                <div id="print-section" class="d-none">
                    <div id="bill-print-content" class="bill-print">
                        <!-- Bill content will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- E-Bill View (hidden) -->
    <div id="e-bill-view" class="d-none">
        <div class="bill-print">
            <div id="e-bill-content">
                <!-- E-Bill content will be generated here -->
            </div>
            <div class="invoice-actions no-print">
                <button class="btn btn-primary" id="print-e-bill">
                    <i class="fas fa-print"></i> Print Bill
                </button>
                <button class="btn btn-success" id="download-e-bill">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button class="btn btn-secondary" id="close-e-bill">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <!-- Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
    apiKey: "AIzaSyAhpW9iqp4O18sIysTyYE1Qk90pCizIysU",
    authDomain: "estront-d6831.firebaseapp.com",
    projectId: "estront-d6831",
    storageBucket: "estront-d6831.firebasestorage.app",
    messagingSenderId: "678690095471",
    appId: "1:678690095471:web:c62279b2c62a6f68ade89a",
    measurementId: "G-1SFVMT2W2E"
  };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Initialize data structure
        let restaurantData = {
            categories: [],
            menuItems: [],
            orders: [],
            tables: [],
            settings: {
                restaurantName: "My Restaurant",
                address: "123 Main St, City",
                phone: "9876543210",
                email: "info@myrestaurant.com",
                gst: "GST123456789",
                logo: "",
                taxRate: 5,
                cgstRate: 2.5,
                sgstRate: 2.5,
                serviceCharge: 10,
                enableDiscount: true,
                autoPrintKitchen: true,
                enableEBill: true
            }
        };

        // Current order
        let currentOrder = {
            items: [],
            tableNumber: 1,
            customerName: "",
            customerPhone: "",
            date: new Date(),
            status: "pending",
            kitchenStatus: "pending"
        };

        // Kitchen order statuses
        const KITCHEN_STATUS = {
            PENDING: 'pending',
            PREPARING: 'preparing',
            READY: 'ready',
            COMPLETED: 'completed'
        };

        // Load data from Firebase
        async function loadData() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                // Load settings
                const settingsDoc = await db.collection('restaurants').doc(user.uid).get();
                if (settingsDoc.exists) {
                    restaurantData.settings = settingsDoc.data().settings || restaurantData.settings;
                }

                // Load categories
                const categoriesSnapshot = await db.collection('restaurants').doc(user.uid).collection('categories').get();
                restaurantData.categories = categoriesSnapshot.docs.map(doc => doc.data().name);

                // Load menu items
                const menuItemsSnapshot = await db.collection('restaurants').doc(user.uid).collection('menuItems').get();
                restaurantData.menuItems = menuItemsSnapshot.docs.map(doc => doc.data());

                // Load tables
                const tablesSnapshot = await db.collection('restaurants').doc(user.uid).collection('tables').get();
                restaurantData.tables = tablesSnapshot.docs.map(doc => doc.data());

                // Load orders
                const ordersSnapshot = await db.collection('restaurants').doc(user.uid).collection('orders').get();
                restaurantData.orders = ordersSnapshot.docs.map(doc => {
                    const data = doc.data();
                    // Convert Firestore Timestamp to Date
                    if (data.date && data.date.toDate) {
                        data.date = data.date.toDate().toISOString();
                    }
                    return data;
                });

                updateUI();
                
                // Restore active section from localStorage
                const activeSection = localStorage.getItem('activeSection') || 'dashboard';
                document.querySelectorAll('.nav-link').forEach(navLink => {
                    navLink.classList.remove('active');
                    if (navLink.dataset.section === activeSection) {
                        navLink.classList.add('active');
                    }
                });
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                    if (section.id === activeSection) {
                        section.classList.add('active');
                    }
                });
                
                // Start checking for kitchen updates
                startKitchenUpdateChecker();
            } catch (error) {
                console.error("Error loading data:", error);
                alert("Error loading data. Please check console for details.");
            }
        }

        // Save data to Firebase
        async function saveData() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                // Save settings
                await db.collection('restaurants').doc(user.uid).set({
                    settings: restaurantData.settings
                }, { merge: true });

                // Save categories (we'll just store them in settings for simplicity)
                // In a real app, you might want to manage these separately

                updateUI();
            } catch (error) {
                console.error("Error saving data:", error);
                alert("Error saving data. Please check console for details.");
            }
        }

        // Save order to Firebase
        async function saveOrder(order) {
            try {
                const user = auth.currentUser;
                if (!user) return;

                // Convert date to Firestore Timestamp
                const orderToSave = {
                    ...order,
                    date: firebase.firestore.Timestamp.fromDate(new Date(order.date))
                };

                await db.collection('restaurants').doc(user.uid).collection('orders').doc(order.id).set(orderToSave);
                
                // Update table status
                await db.collection('restaurants').doc(user.uid).collection('tables')
                    .doc(`table-${order.tableNumber}`).set({
                        number: order.tableNumber,
                        status: 'occupied',
                        orderId: order.id
                    });

                return orderToSave;
            } catch (error) {
                console.error("Error saving order:", error);
                throw error;
            }
        }

        // Update table status in Firebase
        async function updateTableStatus(tableNumber, status, orderId = null) {
            try {
                const user = auth.currentUser;
                if (!user) return;

                await db.collection('restaurants').doc(user.uid).collection('tables')
                    .doc(`table-${tableNumber}`).set({
                        number: tableNumber,
                        status: status,
                        orderId: orderId
                    }, { merge: true });

                // Update local data
                const table = restaurantData.tables.find(t => t.number === tableNumber);
                if (table) {
                    table.status = status;
                    table.orderId = orderId;
                } else {
                    restaurantData.tables.push({
                        number: tableNumber,
                        status: status,
                        orderId: orderId
                    });
                }
            } catch (error) {
                console.error("Error updating table status:", error);
                throw error;
            }
        }

        // Update UI based on current data
        function updateUI() {
            // Dashboard
            updateDashboard();

            // Tables section
            updateTables();
            updateActiveOrdersTable();
            updateTableDropdowns();

            // Orders section
            updateCategories();
            updateMenuItems();
            updateOrderItems();

            // Kitchen view
            updateKitchenView();

            // Menu management
            updateMenuManagement();

            // Reports
            updateAllOrdersTable();

            // Settings
            updateSettingsForm();
        }

        // Kitchen view functions
        function updateKitchenView() {
            updateKitchenOrdersByStatus(KITCHEN_STATUS.PENDING, 'pending-orders-container');
            updateKitchenOrdersByStatus(KITCHEN_STATUS.PREPARING, 'preparing-orders-container');
            updateKitchenOrdersByStatus(KITCHEN_STATUS.READY, 'ready-orders-container');
            updateKitchenOrdersByStatus(KITCHEN_STATUS.COMPLETED, 'completed-orders-container');
            
            // Update kitchen pending count on dashboard
            const pendingCount = restaurantData.orders.filter(order => 
                order.kitchenStatus === KITCHEN_STATUS.PENDING && order.status !== 'completed'
            ).length;
            document.getElementById('kitchen-pending').textContent = pendingCount;
        }

        function updateKitchenOrdersByStatus(status, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const filteredOrders = restaurantData.orders.filter(order => 
                order.kitchenStatus === status && order.status !== 'completed'
            );
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center text-muted py-4">
                        <i class="fas fa-utensils fa-3x mb-3"></i>
                        <p>No ${status} orders</p>
                    </div>
                `;
                return;
            }
            
            filteredOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = `col-md-6 kitchen-order-card ${status}`;
                
                let itemsList = '';
                order.items.forEach(item => {
                    itemsList += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>${item.quantity}x ${item.name}</span>
                            <span class="badge bg-secondary">₹${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `;
                });
                
                orderCard.innerHTML = `
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Order #${order.id}</h5>
                            <span class="badge bg-primary">Table ${order.tableNumber}</span>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <p class="mb-1"><strong>Customer:</strong> ${order.customerName}</p>
                                <p class="mb-1"><strong>Time:</strong> ${new Date(order.date).toLocaleTimeString()}</p>
                            </div>
                            <hr>
                            <div class="mb-3">
                                ${itemsList}
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge order-status-badge bg-${getStatusBadgeColor(order.kitchenStatus)}" 
                                      data-order-id="${order.id}">
                                    ${order.kitchenStatus.toUpperCase()}
                                </span>
                                <button class="btn btn-sm btn-outline-primary print-kitchen-ticket" data-order-id="${order.id}">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(orderCard);
            });
            
            // Add event listeners to status badges
            document.querySelectorAll('.order-status-badge').forEach(badge => {
                badge.addEventListener('click', (e) => {
                    const orderId = e.target.dataset.orderId;
                    updateKitchenOrderStatus(orderId);
                });
            });
            
            // Add event listeners to print buttons
            document.querySelectorAll('.print-kitchen-ticket').forEach(button => {
                button.addEventListener('click', (e) => {
                    const orderId = e.target.closest('button').dataset.orderId;
                    printKitchenTicket(orderId);
                });
            });
        }

        function getStatusBadgeColor(status) {
            switch(status) {
                case KITCHEN_STATUS.PENDING: return 'warning';
                case KITCHEN_STATUS.PREPARING: return 'info';
                case KITCHEN_STATUS.READY: return 'success';
                case KITCHEN_STATUS.COMPLETED: return 'secondary';
                default: return 'primary';
            }
        }

        async function updateKitchenOrderStatus(orderId) {
            try {
                const user = auth.currentUser;
                if (!user) return;

                const order = restaurantData.orders.find(o => o.id === orderId);
                if (!order) return;
                
                // Cycle through statuses
                let newStatus;
                switch(order.kitchenStatus) {
                    case KITCHEN_STATUS.PENDING:
                        newStatus = KITCHEN_STATUS.PREPARING;
                        break;
                    case KITCHEN_STATUS.PREPARING:
                        newStatus = KITCHEN_STATUS.READY;
                        break;
                    case KITCHEN_STATUS.READY:
                        newStatus = KITCHEN_STATUS.COMPLETED;
                        break;
                    case KITCHEN_STATUS.COMPLETED:
                        newStatus = KITCHEN_STATUS.PENDING;
                        break;
                    default:
                        newStatus = KITCHEN_STATUS.PENDING;
                }
                
                // Update in Firebase
                await db.collection('restaurants').doc(user.uid).collection('orders').doc(orderId)
                    .update({
                        kitchenStatus: newStatus
                    });
                
                // Update local data
                order.kitchenStatus = newStatus;
                updateKitchenView();
            } catch (error) {
                console.error("Error updating kitchen order status:", error);
                alert("Error updating order status. Please check console for details.");
            }
        }

        function printKitchenTicket(orderId) {
            const order = restaurantData.orders.find(o => o.id === orderId);
            if (!order) return;
            
            const printContent = generatePrintContent(order, 'kitchen');
            document.getElementById('bill-print-content').innerHTML = printContent;
            window.print();
        }

        function startKitchenUpdateChecker() {
            // Check for updates every 5 seconds
            setInterval(() => {
                loadData();
            }, 5000);
        }

        // Dashboard functions
        function updateDashboard() {
            // Today's date
            const today = new Date().toISOString().split('T')[0];
            
            // Filter today's orders
            const todayOrders = restaurantData.orders.filter(order => {
                return order.date.split('T')[0] === today;
            });
            
            // Calculate today's revenue
            const todayRevenue = todayOrders.reduce((total, order) => {
                return total + calculateOrderTotal(order);
            }, 0);
            
            // Update dashboard numbers
            document.getElementById('today-orders').textContent = todayOrders.length;
            document.getElementById('today-revenue').textContent = `₹${todayRevenue.toFixed(2)}`;
            
            // Active tables (orders with pending status)
            const activeTables = restaurantData.tables.filter(table => table.status === 'occupied').length;
            document.getElementById('active-tables').textContent = activeTables;
            
            // Recent orders
            const recentOrdersTable = document.getElementById('recent-orders');
            recentOrdersTable.innerHTML = '';
            
            const recentOrders = [...restaurantData.orders].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            recentOrders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.id || 'N/A'}</td>
                    <td>Table ${order.tableNumber}</td>
                    <td>₹${calculateOrderTotal(order).toFixed(2)}</td>
                    <td><span class="badge ${order.status === 'completed' ? 'bg-success' : 'bg-warning'}">${order.status}</span></td>
                `;
                recentOrdersTable.appendChild(row);
            });
            
            // Popular items
            const popularItemsTable = document.getElementById('popular-items');
            popularItemsTable.innerHTML = '';
            
            // Count item sales
            const itemSales = {};
            restaurantData.orders.forEach(order => {
                order.items.forEach(item => {
                    if (itemSales[item.name]) {
                        itemSales[item.name].quantity += item.quantity;
                        itemSales[item.name].revenue += item.price * item.quantity;
                    } else {
                        itemSales[item.name] = {
                            quantity: item.quantity,
                            revenue: item.price * item.quantity
                        };
                    }
                });
            });
            
            // Convert to array and sort by quantity
            const popularItems = Object.entries(itemSales)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5);
            
            // Add to table
            popularItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>₹${item.revenue.toFixed(2)}</td>
                `;
                popularItemsTable.appendChild(row);
            });
        }

        // Table management functions
        function updateTables() {
            const tableGrid = document.getElementById('table-status-grid');
            tableGrid.innerHTML = '';
            
            restaurantData.tables.forEach(table => {
                const tableDiv = document.createElement('div');
                tableDiv.className = `table-status ${table.status}`;
                tableDiv.innerHTML = `
                    <div class="text-center">
                        <h5>Table ${table.number}</h5>
                        <p class="mb-0">${table.status.toUpperCase()}</p>
                        ${table.status === 'occupied' ? `<small>Order: ${table.orderId || 'N/A'}</small>` : ''}
                    </div>
                `;
                
                tableDiv.addEventListener('click', () => {
                    if (table.status === 'available') {
                        // Start new order for this table
                        currentOrder.tableNumber = table.number;
                        document.getElementById('table-number').value = table.number;
                        document.getElementById('current-table-number').textContent = table.number;
                        
                        // Switch to orders tab
                        document.querySelector('[data-section="orders"]').click();
                    } else if (table.status === 'occupied') {
                        // View order details
                        viewOrderDetails(table.orderId);
                    }
                });
                
                tableGrid.appendChild(tableDiv);
            });
        }

        function updateActiveOrdersTable() {
            const activeOrdersTable = document.getElementById('active-orders-table');
            activeOrdersTable.innerHTML = '';
            
            const activeOrders = restaurantData.orders.filter(order => order.status === 'pending');
            
            if (activeOrders.length === 0) {
                activeOrdersTable.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">No active orders</td>
                    </tr>
                `;
                return;
            }
            
            activeOrders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.tableNumber}</td>
                    <td>${order.id}</td>
                    <td>${order.items.length}</td>
                    <td>₹${calculateOrderTotal(order).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-order" data-id="${order.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success complete-order" data-id="${order.id}">
                            <i class="fas fa-check"></i>
                        </button>
                    </td>
                `;
                activeOrdersTable.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-order').forEach(button => {
                button.addEventListener('click', (e) => {
                    const orderId = e.target.closest('button').dataset.id;
                    viewOrderDetails(orderId);
                });
            });
            
            document.querySelectorAll('.complete-order').forEach(button => {
                button.addEventListener('click', (e) => {
                    const orderId = e.target.closest('button').dataset.id;
                    completeOrderById(orderId);
                });
            });
        }

        function updateTableDropdowns() {
            const tableSelect = document.getElementById('table-number');
            const removeTableSelect = document.getElementById('remove-table-number');
            
            tableSelect.innerHTML = '';
            removeTableSelect.innerHTML = '';
            
            restaurantData.tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.number;
                option.textContent = `Table ${table.number}`;
                tableSelect.appendChild(option);
                
                const removeOption = document.createElement('option');
                removeOption.value = table.number;
                removeOption.textContent = `Table ${table.number}`;
                removeTableSelect.appendChild(removeOption);
            });
            
            // Set current table in dropdown
            if (currentOrder.tableNumber) {
                tableSelect.value = currentOrder.tableNumber;
                document.getElementById('current-table-number').textContent = currentOrder.tableNumber;
            }
        }

        async function addTable(tableNumber) {
            if (!tableNumber || isNaN(tableNumber) || tableNumber <= 0) {
                alert('Please enter a valid table number');
                return;
            }
            
            if (restaurantData.tables.some(table => table.number === tableNumber)) {
                alert('Table already exists');
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) return;

                await db.collection('restaurants').doc(user.uid).collection('tables')
                    .doc(`table-${tableNumber}`).set({
                        number: tableNumber,
                        status: 'available',
                        orderId: null
                    });
                
                // Update local data
                restaurantData.tables.push({
                    number: tableNumber,
                    status: 'available',
                    orderId: null
                });
                
                document.getElementById('new-table-number').value = '';
                updateTables();
                updateTableDropdowns();
            } catch (error) {
                console.error("Error adding table:", error);
                alert("Error adding table. Please check console for details.");
            }
        }

        async function removeTable(tableNumber) {
            if (!tableNumber) {
                alert('Please select a table to remove');
                return;
            }
            
            // Check if table has active orders
            const table = restaurantData.tables.find(t => t.number === tableNumber);
            if (table && table.status === 'occupied') {
                alert('Cannot remove table with active order');
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) return;

                await db.collection('restaurants').doc(user.uid).collection('tables')
                    .doc(`table-${tableNumber}`).delete();
                
                // Update local data
                restaurantData.tables = restaurantData.tables.filter(t => t.number !== tableNumber);
                updateTables();
                updateTableDropdowns();
            } catch (error) {
                console.error("Error removing table:", error);
                alert("Error removing table. Please check console for details.");
            }
        }

        // Orders section functions
        function updateCategories() {
            const categoriesContainer = document.getElementById('categories');
            categoriesContainer.innerHTML = '';
            
            restaurantData.categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-primary category-btn';
                button.textContent = category;
                button.dataset.category = category;
                button.addEventListener('click', () => filterMenuItems(category));
                categoriesContainer.appendChild(button);
            });
            
            // Add "All" button
            const allButton = document.createElement('button');
            allButton.className = 'btn btn-primary category-btn';
            allButton.textContent = 'All';
            allButton.addEventListener('click', () => filterMenuItems('all'));
            categoriesContainer.prepend(allButton);
        }

        function updateMenuItems(category = 'all') {
            const menuItemsContainer = document.getElementById('menu-items');
            menuItemsContainer.innerHTML = '';
            
            let itemsToShow = [...restaurantData.menuItems];
            
            if (category !== 'all') {
                itemsToShow = itemsToShow.filter(item => item.category === category);
            }
            
            itemsToShow.forEach(item => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';
                
                const card = document.createElement('div');
                card.className = 'card menu-item-card';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${item.name}</h5>
                        <p class="card-text">₹${item.price.toFixed(2)}</p>
                        ${item.description ? `<p class="card-text text-muted small">${item.description}</p>` : ''}
                        <button class="btn btn-sm btn-primary add-to-order" data-id="${item.id}">Add to Order</button>
                    </div>
                `;
                
                col.appendChild(card);
                menuItemsContainer.appendChild(col);
            });
            
            // Add event listeners to add-to-order buttons
            document.querySelectorAll('.add-to-order').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.id;
                    addItemToOrder(itemId);
                });
            });
        }

        function filterMenuItems(category) {
            // Update active category button
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            
            const activeButton = document.querySelector(`.category-btn[data-category="${category}"]`) || 
                                document.querySelector('.category-btn:first-child');
            if (activeButton) {
                activeButton.classList.remove('btn-outline-primary');
                activeButton.classList.add('btn-primary');
            }
            
            updateMenuItems(category);
        }

        function addItemToOrder(itemId) {
            const item = restaurantData.menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            // Check if item already exists in order
            const existingItem = currentOrder.items.find(i => i.id === itemId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                currentOrder.items.push({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: 1
                });
            }
            
            updateOrderItems();
        }

        function updateOrderItems() {
            const orderItemsContainer = document.getElementById('order-items');
            
            if (currentOrder.items.length === 0) {
                orderItemsContainer.innerHTML = '<p class="text-muted text-center">No items added yet</p>';
                document.getElementById('order-total').textContent = '₹0.00';
                return;
            }
            
            orderItemsContainer.innerHTML = '';
            
            currentOrder.items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item d-flex justify-content-between align-items-center';
                itemDiv.innerHTML = `
                    <div>
                        <h6 class="mb-0">${item.name}</h6>
                        <small class="text-muted">₹${item.price.toFixed(2)} × ${item.quantity}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="me-3">₹${(item.price * item.quantity).toFixed(2)}</span>
                        <button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                orderItemsContainer.appendChild(itemDiv);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    removeItemFromOrder(index);
                });
            });
            
            // Update total
            const total = currentOrder.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('order-total').textContent = `₹${total.toFixed(2)}`;
        }

        function removeItemFromOrder(index) {
            currentOrder.items.splice(index, 1);
            updateOrderItems();
        }

        function printKitchenOrder() {
            if (currentOrder.items.length === 0) {
                alert('Please add items to the order before printing');
                return;
            }
            
            const printContent = generatePrintContent(currentOrder, 'kitchen');
            document.getElementById('bill-print-content').innerHTML = printContent;
            
            // Show print dialog
            window.print();
            
            if (restaurantData.settings.autoPrintKitchen) {
                // In a real app, this would send to a kitchen printer
                console.log('Auto-printing kitchen order...');
            }
        }

        async function completeOrder() {
            if (currentOrder.items.length === 0) {
                alert('Please add items to the order before completing');
                return;
            }
            
            // Generate order ID
            const orderId = 'ORD-' + Date.now().toString().slice(-6);
            
            // Create order object
            const order = {
                id: orderId,
                tableNumber: parseInt(document.getElementById('table-number').value),
                customerName: document.getElementById('customer-name').value || 'Walk-in Customer',
                customerPhone: document.getElementById('customer-phone').value || '',
                items: [...currentOrder.items],
                date: new Date().toISOString(),
                status: 'pending', // Changed to pending to allow kitchen processing
                kitchenStatus: KITCHEN_STATUS.PENDING
            };
            
            try {
                // Save to Firebase
                await saveOrder(order);
                
                // Add to local orders
                restaurantData.orders.push(order);
                
                // Print kitchen order
                const printContent = generatePrintContent(order, 'kitchen');
                document.getElementById('bill-print-content').innerHTML = printContent;
                window.print();
                
                // Reset current order
                currentOrder.items = [];
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-phone').value = '';
                updateOrderItems();
                
                // Generate e-bill if enabled and customer phone provided
                if (restaurantData.settings.enableEBill && order.customerPhone) {
                    sendEBill(order);
                }
                
                alert(`Order ${orderId} sent to kitchen successfully!`);
            } catch (error) {
                console.error("Error completing order:", error);
                alert("Error completing order. Please check console for details.");
            }
        }

        async function completeOrderById(orderId) {
            const order = restaurantData.orders.find(o => o.id === orderId);
            if (!order) return;
            
            try {
                const user = auth.currentUser;
                if (!user) return;

                // Update in Firebase
                await db.collection('restaurants').doc(user.uid).collection('orders').doc(orderId)
                    .update({
                        status: 'completed',
                        kitchenStatus: KITCHEN_STATUS.COMPLETED
                    });
                
                // Update table status
                await updateTableStatus(order.tableNumber, 'available');
                
                // Update local data
                order.status = 'completed';
                order.kitchenStatus = KITCHEN_STATUS.COMPLETED;
                
                // Print customer bill
                const printContent = generatePrintContent(order, 'customer');
                document.getElementById('bill-print-content').innerHTML = printContent;
                window.print();
                
                alert(`Order ${orderId} completed successfully!`);
            } catch (error) {
                console.error("Error completing order:", error);
                alert("Error completing order. Please check console for details.");
            }
        }

        // Menu management functions
        function updateMenuManagement() {
            // Update category dropdown
            const categorySelect = document.getElementById('item-category');
            categorySelect.innerHTML = '';
            
            restaurantData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            // Update menu items accordion
            const accordion = document.getElementById('menu-categories-accordion');
            accordion.innerHTML = '';
            
            restaurantData.categories.forEach((category, index) => {
                const categoryItems = restaurantData.menuItems.filter(item => item.category === category);
                
                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                
                const accordionHeader = document.createElement('h2');
                accordionHeader.className = 'accordion-header';
                accordionHeader.id = `heading-${index}`;
                
                const accordionButton = document.createElement('button');
                accordionButton.className = 'accordion-button';
                accordionButton.type = 'button';
                accordionButton.dataset.bsToggle = 'collapse';
                accordionButton.dataset.bsTarget = `#collapse-${index}`;
                accordionButton.setAttribute('aria-expanded', index === 0 ? 'true' : 'false');
                accordionButton.setAttribute('aria-controls', `collapse-${index}`);
                accordionButton.textContent = `${category} (${categoryItems.length} items)`;
                
                accordionHeader.appendChild(accordionButton);
                
                const accordionCollapse = document.createElement('div');
                accordionCollapse.className = `accordion-collapse collapse ${index === 0 ? 'show' : ''}`;
                accordionCollapse.id = `collapse-${index}`;
                accordionCollapse.setAttribute('aria-labelledby', `heading-${index}`);
                accordionCollapse.dataset.bsParent = '#menu-categories-accordion';
                
                const accordionBody = document.createElement('div');
                accordionBody.className = 'accordion-body';
                
                if (categoryItems.length === 0) {
                    accordionBody.innerHTML = '<p class="text-muted">No items in this category</p>';
                } else {
                    const table = document.createElement('table');
                    table.className = 'table table-sm';
                    
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th>Item</th>
                            <th>Price</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    `;
                    
                    const tbody = document.createElement('tbody');
                    
                    categoryItems.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.name}</td>
                            <td>₹${item.price.toFixed(2)}</td>
                            <td>${item.description || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger delete-item" data-id="${item.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    table.appendChild(thead);
                    table.appendChild(tbody);
                    accordionBody.appendChild(table);
                }
                
                accordionCollapse.appendChild(accordionBody);
                accordionItem.appendChild(accordionHeader);
                accordionItem.appendChild(accordionCollapse);
                accordion.appendChild(accordionItem);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.closest('button').dataset.id;
                    deleteMenuItem(itemId);
                });
            });
        }

        async function addCategory() {
            const categoryName = document.getElementById('category-name').value.trim();
            
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }
            
            if (restaurantData.categories.includes(categoryName)) {
                alert('Category already exists');
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) return;

                // Add to Firebase
                await db.collection('restaurants').doc(user.uid).collection('categories')
                    .doc(categoryName.toLowerCase().replace(/\s+/g, '-'))
                    .set({ name: categoryName });
                
                // Update local data
                restaurantData.categories.push(categoryName);
                document.getElementById('category-name').value = '';
                
                // Update UI
                updateCategories();
                updateMenuManagement();
            } catch (error) {
                console.error("Error adding category:", error);
                alert("Error adding category. Please check console for details.");
            }
        }

        async function addMenuItem() {
            const category = document.getElementById('item-category').value;
            const name = document.getElementById('item-name').value.trim();
            const price = parseFloat(document.getElementById('item-price').value);
            const description = document.getElementById('item-description').value.trim();
            
            if (!name || isNaN(price) || price <= 0) {
                alert('Please fill all required fields with valid values');
                return;
            }
            
            // Generate item ID
            const id = 'ITEM-' + Date.now().toString().slice(-6);
            
            try {
                const user = auth.currentUser;
                if (!user) return;

                // Add to Firebase
                await db.collection('restaurants').doc(user.uid).collection('menuItems').doc(id).set({
                    id,
                    name,
                    price,
                    category,
                    description
                });
                
                // Update local data
                restaurantData.menuItems.push({
                    id,
                    name,
                    price,
                    category,
                    description
                });
                
                // Clear form
                document.getElementById('item-name').value = '';
                document.getElementById('item-price').value = '';
                document.getElementById('item-description').value = '';
                
                // Update UI
                updateMenuItems();
                updateMenuManagement();
            } catch (error) {
                console.error("Error adding menu item:", error);
                alert("Error adding menu item. Please check console for details.");
            }
        }

        async function deleteMenuItem(itemId) {
            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    const user = auth.currentUser;
                    if (!user) return;

                    // Delete from Firebase
                    await db.collection('restaurants').doc(user.uid).collection('menuItems').doc(itemId).delete();
                    
                    // Update local data
                    restaurantData.menuItems = restaurantData.menuItems.filter(item => item.id !== itemId);
                    
                    // Update UI
                    updateMenuItems();
                    updateMenuManagement();
                } catch (error) {
                    console.error("Error deleting menu item:", error);
                    alert("Error deleting menu item. Please check console for details.");
                }
            }
        }

        // Reports functions
        function updateAllOrdersTable() {
            const tableBody = document.getElementById('all-orders-table');
            tableBody.innerHTML = '';
            
            const sortedOrders = [...restaurantData.orders].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedOrders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${new Date(order.date).toLocaleString()}</td>
                    <td>Table ${order.tableNumber}</td>
                    <td>${order.customerName}</td>
                    <td>₹${calculateOrderTotal(order).toFixed(2)}</td>
                    <td>
                        <span class="badge ${order.status === 'completed' ? 'bg-success' : 'bg-warning'}">
                            ${order.status}
                        </span>
                        ${order.kitchenStatus ? `<span class="badge bg-${getStatusBadgeColor(order.kitchenStatus)} ms-1">
                            ${order.kitchenStatus}
                        </span>` : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-order" data-id="${order.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-order" data-id="${order.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-order').forEach(button => {
                button.addEventListener('click', (e) => {
                    const orderId = e.target.closest('button').dataset.id;
                    viewOrderDetails(orderId);
                });
            });
            
            document.querySelectorAll('.delete-order').forEach(button => {
                button.addEventListener('click', (e) => {
                    const orderId = e.target.closest('button').dataset.id;
                    deleteOrder(orderId);
                });
            });
        }

        function viewOrderDetails(orderId) {
            const order = restaurantData.orders.find(o => o.id === orderId);
            if (!order) return;
            
            const printContent = generatePrintContent(order, 'admin');
            document.getElementById('bill-print-content').innerHTML = printContent;
            
            // Show print dialog
            window.print();
        }

        async function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                try {
                    const user = auth.currentUser;
                    if (!user) return;

                    const order = restaurantData.orders.find(o => o.id === orderId);
                    if (order) {
                        // Update table status if order was active
                        if (order.status === 'pending') {
                            await updateTableStatus(order.tableNumber, 'available');
                        }
                        
                        // Delete from Firebase
                        await db.collection('restaurants').doc(user.uid).collection('orders').doc(orderId).delete();
                    }
                    
                    // Update local data
                    restaurantData.orders = restaurantData.orders.filter(order => order.id !== orderId);
                    
                    // Update UI
                    updateAllOrdersTable();
                    updateActiveOrdersTable();
                    updateTables();
                } catch (error) {
                    console.error("Error deleting order:", error);
                    alert("Error deleting order. Please check console for details.");
                }
            }
        }

        function generateSalesReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const reportType = document.getElementById('report-type').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const filteredOrders = restaurantData.orders.filter(order => {
                const orderDate = order.date.split('T')[0];
                return orderDate >= startDate && orderDate <= endDate;
            });
            
            if (filteredOrders.length === 0) {
                document.getElementById('sales-report-results').innerHTML = `
                    <div class="alert alert-info">No orders found for the selected date range</div>
                `;
                return;
            }
            
            // Calculate totals
            const totalOrders = filteredOrders.length;
            const totalRevenue = filteredOrders.reduce((sum, order) => sum + calculateOrderTotal(order), 0);
            const avgOrderValue = totalRevenue / totalOrders;
            
            // Group by category
            const categorySales = {};
            filteredOrders.forEach(order => {
                order.items.forEach(item => {
                    const menuItem = restaurantData.menuItems.find(mi => mi.id === item.id);
                    if (menuItem) {
                        if (categorySales[menuItem.category]) {
                            categorySales[menuItem.category].quantity += item.quantity;
                            categorySales[menuItem.category].revenue += item.price * item.quantity;
                        } else {
                            categorySales[menuItem.category] = {
                                quantity: item.quantity,
                                revenue: item.price * item.quantity
                            };
                        }
                    }
                });
            });
            
            // Create category sales table
            let categoryTable = '';
            for (const [category, data] of Object.entries(categorySales)) {
                categoryTable += `
                    <tr>
                        <td>${category}</td>
                        <td>${data.quantity}</td>
                        <td>₹${data.revenue.toFixed(2)}</td>
                        <td>${((data.revenue / totalRevenue) * 100).toFixed(1)}%</td>
                    </tr>
                `;
            }
            
            // Tax calculations
            const taxRate = restaurantData.settings.taxRate || 5;
            const cgstRate = restaurantData.settings.cgstRate || 2.5;
            const sgstRate = restaurantData.settings.sgstRate || 2.5;
            const serviceChargeRate = restaurantData.settings.serviceCharge || 10;
            
            const totalTax = filteredOrders.reduce((sum, order) => {
                const orderTotal = calculateOrderTotal(order);
                return sum + (orderTotal * (taxRate / 100));
            }, 0);
            
            const totalCGST = filteredOrders.reduce((sum, order) => {
                const orderTotal = calculateOrderTotal(order);
                return sum + (orderTotal * (cgstRate / 100));
            }, 0);
            
            const totalSGST = filteredOrders.reduce((sum, order) => {
                const orderTotal = calculateOrderTotal(order);
                return sum + (orderTotal * (sgstRate / 100));
            }, 0);
            
            const totalServiceCharge = filteredOrders.reduce((sum, order) => {
                const orderTotal = calculateOrderTotal(order);
                return sum + (orderTotal * (serviceChargeRate / 100));
            }, 0);
            
            // Display results based on report type
            if (reportType === 'summary') {
                document.getElementById('sales-report-results').innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5>Sales Summary Report: ${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Total Orders</h6>
                                            <h3 class="card-text">${totalOrders}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Total Revenue</h6>
                                            <h3 class="card-text">₹${totalRevenue.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Avg. Order Value</h6>
                                            <h3 class="card-text">₹${avgOrderValue.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Total Tax</h6>
                                            <h3 class="card-text">₹${totalTax.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h5>Sales by Category</h5>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Revenue</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${categoryTable}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (reportType === 'detailed') {
                let ordersTable = '';
                filteredOrders.forEach(order => {
                    ordersTable += `
                        <tr>
                            <td>${order.id}</td>
                            <td>${new Date(order.date).toLocaleDateString()}</td>
                            <td>Table ${order.tableNumber}</td>
                            <td>${order.customerName}</td>
                            <td>${order.items.length}</td>
                            <td>₹${calculateOrderTotal(order).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                document.getElementById('sales-report-results').innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5>Detailed Sales Report: ${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Total Orders</h6>
                                            <h3 class="card-text">${totalOrders}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Total Revenue</h6>
                                            <h3 class="card-text">₹${totalRevenue.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Avg. Order Value</h6>
                                            <h3 class="card-text">₹${avgOrderValue.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h5>All Orders</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Date</th>
                                            <th>Table</th>
                                            <th>Customer</th>
                                            <th>Items</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${ordersTable}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else if (reportType === 'tax') {
                document.getElementById('sales-report-results').innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h5>Tax Report: ${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Total Revenue</h6>
                                            <h3 class="card-text">₹${totalRevenue.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Total Tax (${taxRate}%)</h6>
                                            <h3 class="card-text">₹${totalTax.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">CGST (${cgstRate}%)</h6>
                                            <h3 class="card-text">₹${totalCGST.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">SGST (${sgstRate}%)</h6>
                                            <h3 class="card-text">₹${totalSGST.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Service Charge (${serviceChargeRate}%)</h6>
                                            <h3 class="card-text">₹${totalServiceCharge.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Total Orders</h6>
                                            <h3 class="card-text">${totalOrders}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Avg. Order Value</h6>
                                            <h3 class="card-text">₹${avgOrderValue.toFixed(2)}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h5>Tax Breakdown by Order</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Date</th>
                                            <th>Subtotal</th>
                                            <th>Tax (${taxRate}%)</th>
                                            <th>CGST (${cgstRate}%)</th>
                                            <th>SGST (${sgstRate}%)</th>
                                            <th>Service Charge (${serviceChargeRate}%)</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredOrders.map(order => {
                                            const subtotal = calculateOrderTotal(order);
                                            const tax = subtotal * (taxRate / 100);
                                            const cgst = subtotal * (cgstRate / 100);
                                            const sgst = subtotal * (sgstRate / 100);
                                            const serviceCharge = subtotal * (serviceChargeRate / 100);
                                            const total = subtotal + tax + serviceCharge;
                                            
                                            return `
                                                <tr>
                                                    <td>${order.id}</td>
                                                    <td>${new Date(order.date).toLocaleDateString()}</td>
                                                    <td>₹${subtotal.toFixed(2)}</td>
                                                    <td>₹${tax.toFixed(2)}</td>
                                                    <td>₹${cgst.toFixed(2)}</td>
                                                    <td>₹${sgst.toFixed(2)}</td>
                                                    <td>₹${serviceCharge.toFixed(2)}</td>
                                                    <td>₹${total.toFixed(2)}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function exportReportToExcel() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const filteredOrders = restaurantData.orders.filter(order => {
                const orderDate = order.date.split('T')[0];
                return orderDate >= startDate && orderDate <= endDate;
            });
            
            if (filteredOrders.length === 0) {
                alert('No orders found for the selected date range');
                return;
            }
            
            // Prepare data for Excel
            const excelData = filteredOrders.map(order => {
                const subtotal = calculateOrderTotal(order);
                const taxRate = restaurantData.settings.taxRate || 5;
                const cgstRate = restaurantData.settings.cgstRate || 2.5;
                const sgstRate = restaurantData.settings.sgstRate || 2.5;
                const serviceChargeRate = restaurantData.settings.serviceCharge || 10;
                
                const tax = subtotal * (taxRate / 100);
                const cgst = subtotal * (cgstRate / 100);
                const sgst = subtotal * (sgstRate / 100);
                const serviceCharge = subtotal * (serviceChargeRate / 100);
                const total = subtotal + tax + serviceCharge;
                
                return {
                    'Order ID': order.id,
                    'Date': new Date(order.date).toLocaleDateString(),
                    'Table': order.tableNumber,
                    'Customer': order.customerName,
                    'Items Count': order.items.length,
                    'Subtotal': subtotal,
                    'Tax': tax,
                    'CGST': cgst,
                    'SGST': sgst,
                    'Service Charge': serviceCharge,
                    'Total': total,
                    'Status': order.status,
                    'Kitchen Status': order.kitchenStatus || 'N/A'
                };
            });
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sales Report");
            
            // Generate file name
            const fileName = `Sales_Report_${startDate}_to_${endDate}.xlsx`;
            
            // Export to Excel
            XLSX.writeFile(wb, fileName);
        }

        // Print functions
        function printBill(orderId, type) {
            const order = restaurantData.orders.find(o => o.id === orderId);
            if (!order) {
                alert('Order not found');
                return;
            }
            
            if (type === 'customer') {
                // Show e-bill view for customer
                showEBill(order);
            } else {
                const printContent = generatePrintContent(order, type);
                document.getElementById('bill-print-content').innerHTML = printContent;
                
                // Show print dialog
                window.print();
            }
        }

        function generatePrintContent(order, type) {
            const settings = restaurantData.settings;
            const orderTotal = calculateOrderTotal(order);
            const taxRate = settings.taxRate || 5;
            const cgstRate = settings.cgstRate || 2.5;
            const sgstRate = settings.sgstRate || 2.5;
            const serviceChargeRate = settings.serviceCharge || 10;
            
            const taxAmount = orderTotal * (taxRate / 100);
            const cgstAmount = orderTotal * (cgstRate / 100);
            const sgstAmount = orderTotal * (sgstRate / 100);
            const serviceCharge = orderTotal * (serviceChargeRate / 100);
            const grandTotal = orderTotal + taxAmount + serviceCharge;
            
            let content = '';
            
            // Header
            content += `
                <div class="text-center mb-3">
                    ${settings.logo ? `<img src="${settings.logo}" alt="Restaurant Logo" style="max-height: 80px; margin-bottom: 10px;">` : ''}
                    <h3>${settings.restaurantName}</h3>
                    <p class="mb-1">${settings.address}</p>
                    <p class="mb-1">Phone: ${settings.phone}</p>
                    ${settings.email ? `<p class="mb-1">Email: ${settings.email}</p>` : ''}
                    ${settings.gst ? `<p class="mb-1">GST: ${settings.gst}</p>` : ''}
                    <hr>
                    <h4>${type === 'kitchen' ? 'KITCHEN ORDER' : type === 'admin' ? 'ADMIN COPY' : 'CUSTOMER COPY'}</h4>
                    <hr>
                </div>
            `;
            
            // Order info
            content += `
                <div class="row mb-3">
                    <div class="col-6">
                        <p><strong>Order #:</strong> ${order.id}</p>
                        <p><strong>Date:</strong> ${new Date(order.date).toLocaleString()}</p>
                    </div>
                    <div class="col-6 text-end">
                        <p><strong>Table #:</strong> ${order.tableNumber}</p>
                        <p><strong>Customer:</strong> ${order.customerName}</p>
                        ${order.customerPhone ? `<p><strong>Phone:</strong> ${order.customerPhone}</p>` : ''}
                    </div>
                </div>
            `;
            
            // Items table
            content += `
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th class="text-end">Qty</th>
                            <th class="text-end">Price</th>
                            ${type !== 'kitchen' ? '<th class="text-end">Amount</th>' : ''}
                            ${type === 'kitchen' ? '<th class="text-end">Status</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            order.items.forEach(item => {
                content += `
                    <tr>
                        <td>${item.name}</td>
                        <td class="text-end">${item.quantity}</td>
                        <td class="text-end">₹${item.price.toFixed(2)}</td>
                        ${type !== 'kitchen' ? `<td class="text-end">₹${(item.price * item.quantity).toFixed(2)}</td>` : ''}
                        ${type === 'kitchen' ? `<td class="text-end"><span class="badge bg-secondary">Pending</span></td>` : ''}
                    </tr>
                `;
            });
            
            content += `</tbody></table>`;
            
            // Footer (only for admin and customer copies)
            if (type !== 'kitchen') {
                content += `
                    <div class="text-end">
                        <p><strong>Subtotal:</strong> ₹${orderTotal.toFixed(2)}</p>
                        ${taxRate > 0 ? `<p><strong>Tax (${taxRate}%):</strong> ₹${taxAmount.toFixed(2)}</p>` : ''}
                        ${cgstRate > 0 ? `<p><strong>CGST (${cgstRate}%):</strong> ₹${cgstAmount.toFixed(2)}</p>` : ''}
                        ${sgstRate > 0 ? `<p><strong>SGST (${sgstRate}%):</strong> ₹${sgstAmount.toFixed(2)}</p>` : ''}
                        ${serviceChargeRate > 0 ? `<p><strong>Service Charge (${serviceChargeRate}%):</strong> ₹${serviceCharge.toFixed(2)}</p>` : ''}
                        <h5><strong>Grand Total:</strong> ₹${grandTotal.toFixed(2)}</h5>
                    </div>
                `;
                
                if (type === 'customer') {
                    content += `
                        <hr>
                        <div class="text-center mt-3">
                            <p>Thank you for dining with us!</p>
                            <p>Please visit again</p>
                        </div>
                    `;
                }
            } else {
                // Kitchen specific content
                content += `
                    <hr>
                    <div class="text-center mt-3">
                        <p><strong>Order Time:</strong> ${new Date(order.date).toLocaleTimeString()}</p>
                        <p class="text-muted">Please prepare with care</p>
                    </div>
                `;
            }
            
            return content;
        }

        function calculateOrderTotal(order) {
            return order.items.reduce((total, item) => total + (item.price * item.quantity), 0);
        }

        // E-Bill functions
        function showEBill(order) {
            const eBillContent = document.getElementById('e-bill-content');
            eBillContent.innerHTML = generatePrintContent(order, 'customer');
            
            // Generate QR code for payment or reference
            const qrCodeContainer = document.createElement('div');
            qrCodeContainer.className = 'qr-code-container';
            qrCodeContainer.innerHTML = `
                <p class="mb-2"><strong>Scan to pay or view bill online</strong></p>
                <div id="qr-code" class="qr-code"></div>
                <p class="mt-2 small text-muted">Reference: ${order.id}</p>
            `;
            eBillContent.appendChild(qrCodeContainer);
            
            // Generate QR code
            new QRCode(document.getElementById("qr-code"), {
                text: `https://myrestaurant.com/bill/${order.id}`,
                width: 150,
                height: 150,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            // Show e-bill view
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('e-bill-view').style.display = 'block';
        }

        function closeEBill() {
            document.getElementById('e-bill-view').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }

        function printEBill() {
            window.print();
        }

        function downloadEBill() {
            // In a real app, this would generate a PDF
            alert('PDF download would be implemented here');
        }

        async function sendEBill(order) {
            try {
                document.getElementById('e-bill-status').innerHTML = `
                    <div class="alert alert-info">Sending e-bill to ${order.customerPhone}...</div>
                `;
                
                // In a real app, this would integrate with an SMS/email service
                // For demo purposes, we'll just simulate it
                setTimeout(() => {
                    document.getElementById('e-bill-status').innerHTML = `
                        <div class="alert alert-success">
                            E-bill sent successfully to ${order.customerPhone}!<br>
                            <small>View link: https://myrestaurant.com/bill/${order.id}</small>
                        </div>
                    `;
                }, 2000);
                
                // Save the e-bill reference
                await db.collection('restaurants').doc(auth.currentUser.uid)
                    .collection('orders').doc(order.id)
                    .update({
                        eBillSent: true,
                        eBillLink: `https://myrestaurant.com/bill/${order.id}`
                    });
            } catch (error) {
                console.error("Error sending e-bill:", error);
                document.getElementById('e-bill-status').innerHTML = `
                    <div class="alert alert-danger">Error sending e-bill. Please try again.</div>
                `;
            }
        }

        // Settings functions
        function updateSettingsForm() {
            const settings = restaurantData.settings;
            
            document.getElementById('restaurant-name').value = settings.restaurantName;
            document.getElementById('restaurant-address').value = settings.address;
            document.getElementById('restaurant-phone').value = settings.phone;
            document.getElementById('restaurant-email').value = settings.email || '';
            document.getElementById('restaurant-gst').value = settings.gst || '';
            document.getElementById('restaurant-logo').value = settings.logo || '';
            
            document.getElementById('tax-rate').value = settings.taxRate;
            document.getElementById('cgst-rate').value = settings.cgstRate;
            document.getElementById('sgst-rate').value = settings.sgstRate;
            document.getElementById('service-charge').value = settings.serviceCharge;
            document.getElementById('enable-discount').checked = settings.enableDiscount;
            document.getElementById('auto-print-kitchen').checked = settings.autoPrintKitchen;
            document.getElementById('enable-e-bill').checked = settings.enableEBill;
        }

        async function saveRestaurantInfo() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                restaurantData.settings.restaurantName = document.getElementById('restaurant-name').value;
                restaurantData.settings.address = document.getElementById('restaurant-address').value;
                restaurantData.settings.phone = document.getElementById('restaurant-phone').value;
                restaurantData.settings.email = document.getElementById('restaurant-email').value;
                restaurantData.settings.gst = document.getElementById('restaurant-gst').value;
                restaurantData.settings.logo = document.getElementById('restaurant-logo').value;
                
                await db.collection('restaurants').doc(user.uid).set({
                    settings: restaurantData.settings
                }, { merge: true });
                
                alert('Restaurant information saved successfully');
            } catch (error) {
                console.error("Error saving restaurant info:", error);
                alert("Error saving restaurant info. Please check console for details.");
            }
        }

        async function saveSystemSettings() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                restaurantData.settings.taxRate = parseFloat(document.getElementById('tax-rate').value);
                restaurantData.settings.cgstRate = parseFloat(document.getElementById('cgst-rate').value);
                restaurantData.settings.sgstRate = parseFloat(document.getElementById('sgst-rate').value);
                restaurantData.settings.serviceCharge = parseFloat(document.getElementById('service-charge').value);
                restaurantData.settings.enableDiscount = document.getElementById('enable-discount').checked;
                restaurantData.settings.autoPrintKitchen = document.getElementById('auto-print-kitchen').checked;
                restaurantData.settings.enableEBill = document.getElementById('enable-e-bill').checked;
                
                await db.collection('restaurants').doc(user.uid).set({
                    settings: restaurantData.settings
                }, { merge: true });
                
                alert('System settings saved successfully');
            } catch (error) {
                console.error("Error saving system settings:", error);
                alert("Error saving system settings. Please check console for details.");
            }
        }

        async function resetData() {
            if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
                try {
                    const user = auth.currentUser;
                    if (!user) return;

                    // Delete all collections
                    const collections = ['categories', 'menuItems', 'orders', 'tables'];
                    for (const collection of collections) {
                        const snapshot = await db.collection('restaurants').doc(user.uid).collection(collection).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                    }
                    
                    // Reset settings
                    await db.collection('restaurants').doc(user.uid).set({
                        settings: {
                            restaurantName: "My Restaurant",
                            address: "123 Main St, City",
                            phone: "9876543210",
                            email: "info@myrestaurant.com",
                            gst: "GST123456789",
                            logo: "",
                            taxRate: 5,
                            cgstRate: 2.5,
                            sgstRate: 2.5,
                            serviceCharge: 10,
                            enableDiscount: true,
                            autoPrintKitchen: true,
                            enableEBill: true
                        }
                    });
                    
                    // Reload data
                    await loadData();
                    alert('All data has been reset to default');
                } catch (error) {
                    console.error("Error resetting data:", error);
                    alert("Error resetting data. Please check console for details.");
                }
            }
        }

        // Authentication functions
        async function login(email, password) {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log("User logged in:", userCredential.user);
                
                // Hide login and show app
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                // Load data
                await loadData();
            } catch (error) {
                console.error("Login error:", error);
                alert("Login failed: " + error.message);
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                console.log("User logged out");
                
                // Show login and hide app
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('app-container').style.display = 'none';
                
                // Clear form
                document.getElementById('login-form').reset();
            } catch (error) {
                console.error("Logout error:", error);
                alert("Logout failed: " + error.message);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase auth state observer
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    loadData();
                } else {
                    // User is signed out
                    document.getElementById('login-section').style.display = 'block';
                    document.getElementById('app-container').style.display = 'none';
                }
            });
            
            // Login form
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                login(email, password);
            });
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
            
            // Navigation
            document.querySelectorAll('[data-section]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Update active nav link
                    document.querySelectorAll('.nav-link').forEach(navLink => {
                        navLink.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Show corresponding section
                    const sectionId = e.target.dataset.section;
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Save the active section to localStorage
                    localStorage.setItem('activeSection', sectionId);
                });
            });
            
            // Tables section
            document.getElementById('refresh-tables').addEventListener('click', updateTables);
            
            document.getElementById('add-table-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const tableNumber = parseInt(document.getElementById('new-table-number').value);
                addTable(tableNumber);
            });
            
            document.getElementById('remove-table-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const tableNumber = parseInt(document.getElementById('remove-table-number').value);
                removeTable(tableNumber);
            });
            
            // Orders section
            document.getElementById('table-number').addEventListener('change', (e) => {
                currentOrder.tableNumber = parseInt(e.target.value);
                document.getElementById('current-table-number').textContent = e.target.value;
            });
            
            document.getElementById('customer-name').addEventListener('input', (e) => {
                currentOrder.customerName = e.target.value;
            });
            
            document.getElementById('customer-phone').addEventListener('input', (e) => {
                currentOrder.customerPhone = e.target.value;
            });
            
            document.getElementById('clear-order').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear the current order?')) {
                    currentOrder.items = [];
                    updateOrderItems();
                }
            });
            
            document.getElementById('print-kitchen-order').addEventListener('click', (e) => {
                e.preventDefault();
                printKitchenOrder();
            });
            
            document.getElementById('complete-order').addEventListener('click', (e) => {
                e.preventDefault();
                completeOrder();
            });
            
            // Kitchen section
            document.getElementById('refresh-kitchen').addEventListener('click', updateKitchenView);
            
            // Menu management
            document.getElementById('add-category-form').addEventListener('submit', (e) => {
                e.preventDefault();
                addCategory();
            });
            
            document.getElementById('add-item-form').addEventListener('submit', (e) => {
                e.preventDefault();
                addMenuItem();
            });
            
            // Reports
            document.getElementById('sales-report-form').addEventListener('submit', (e) => {
                e.preventDefault();
                generateSalesReport();
            });
            
            document.getElementById('export-report').addEventListener('click', exportReportToExcel);
            
            document.getElementById('print-kitchen-bill').addEventListener('click', () => {
                const orderId = document.getElementById('bill-order-id').value;
                if (orderId) {
                    printBill(orderId, 'kitchen');
                } else {
                    alert('Please enter an order ID');
                }
            });
            
            document.getElementById('print-customer-bill').addEventListener('click', () => {
                const orderId = document.getElementById('bill-order-id').value;
                if (orderId) {
                    printBill(orderId, 'customer');
                } else {
                    alert('Please enter an order ID');
                }
            });
            
            document.getElementById('print-admin-bill').addEventListener('click', () => {
                const orderId = document.getElementById('bill-order-id').value;
                if (orderId) {
                    printBill(orderId, 'admin');
                } else {
                    alert('Please enter an order ID');
                }
            });
            
            document.getElementById('send-e-bill').addEventListener('click', () => {
                const orderId = document.getElementById('bill-order-id').value;
                if (orderId) {
                    const order = restaurantData.orders.find(o => o.id === orderId);
                    if (order) {
                        if (order.customerPhone) {
                            sendEBill(order);
                        } else {
                            alert('This order does not have a customer phone number');
                        }
                    } else {
                        alert('Order not found');
                    }
                } else {
                    alert('Please enter an order ID');
                }
            });
            
            // Settings
            document.getElementById('restaurant-info-form').addEventListener('submit', (e) => {
                e.preventDefault();
                saveRestaurantInfo();
            });
            
            document.getElementById('system-settings-form').addEventListener('submit', (e) => {
                e.preventDefault();
                saveSystemSettings();
            });
            
            document.getElementById('reset-data').addEventListener('click', resetData);
            
            // E-Bill actions
            document.getElementById('print-e-bill').addEventListener('click', printEBill);
            document.getElementById('download-e-bill').addEventListener('click', downloadEBill);
            document.getElementById('close-e-bill').addEventListener('click', closeEBill);
        });

        // Initialize with some sample data if empty (for demo purposes)
        async function initializeSampleData() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                // Check if data already exists
                const settingsDoc = await db.collection('restaurants').doc(user.uid).get();
                if (settingsDoc.exists) return;

                // Initialize categories
                const categories = ['Starters', 'Main Course', 'Desserts', 'Beverages'];
                for (const category of categories) {
                    await db.collection('restaurants').doc(user.uid).collection('categories')
                        .doc(category.toLowerCase().replace(/\s+/g, '-'))
                        .set({ name: category });
                }

                // Initialize menu items
                const menuItems = [
                    { id: 'ITEM-1', name: 'Vegetable Soup', price: 120, category: 'Starters', description: 'Fresh vegetable soup with herbs' },
                    { id: 'ITEM-2', name: 'Chicken Wings', price: 180, category: 'Starters', description: 'Spicy crispy chicken wings' },
                    { id: 'ITEM-3', name: 'Paneer Tikka', price: 150, category: 'Starters', description: 'Grilled cottage cheese with spices' },
                    { id: 'ITEM-4', name: 'Butter Chicken', price: 250, category: 'Main Course', description: 'Chicken in creamy tomato sauce' },
                    { id: 'ITEM-5', name: 'Dal Makhani', price: 180, category: 'Main Course', description: 'Creamy black lentils' },
                    { id: 'ITEM-6', name: 'Vegetable Biryani', price: 200, category: 'Main Course', description: 'Fragrant rice with mixed vegetables' },
                    { id: 'ITEM-7', name: 'Ice Cream', price: 80, category: 'Desserts', description: 'Vanilla, chocolate or strawberry' },
                    { id: 'ITEM-8', name: 'Gulab Jamun', price: 60, category: 'Desserts', description: 'Sweet milk balls in syrup' },
                    { id: 'ITEM-9', name: 'Cold Coffee', price: 90, category: 'Beverages', description: 'Iced coffee with milk' },
                    { id: 'ITEM-10', name: 'Fresh Lime Soda', price: 50, category: 'Beverages', description: 'Refreshing lime drink' }
                ];
                
                for (const item of menuItems) {
                    await db.collection('restaurants').doc(user.uid).collection('menuItems').doc(item.id).set(item);
                }

                // Initialize tables
                for (let i = 1; i <= 10; i++) {
                    await db.collection('restaurants').doc(user.uid).collection('tables')
                        .doc(`table-${i}`).set({
                            number: i,
                            status: 'available',
                            orderId: null
                        });
                }

                // Initialize settings
                await db.collection('restaurants').doc(user.uid).set({
                    settings: {
                        restaurantName: "My Restaurant",
                        address: "123 Main St, City",
                        phone: "9876543210",
                        email: "info@myrestaurant.com",
                        gst: "GST123456789",
                        logo: "",
                        taxRate: 5,
                        cgstRate: 2.5,
                        sgstRate: 2.5,
                        serviceCharge: 10,
                        enableDiscount: true,
                        autoPrintKitchen: true,
                        enableEBill: true
                    }
                });

                console.log("Sample data initialized");
            } catch (error) {
                console.error("Error initializing sample data:", error);
            }
        }
    </script>
</body>
</html>
